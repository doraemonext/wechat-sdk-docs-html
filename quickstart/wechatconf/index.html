<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://wechat-python-sdk.com/quickstart/wechatconf/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>3. WechatConf 详解 - wechat-python-sdk</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">wechat-python-sdk</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">首页</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">快速上手 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../intro/">1. SDK 快速介绍</a>
</li>

                    
                        
<li >
    <a href="../official/">2. 官方接口</a>
</li>

                    
                        
<li class="active">
    <a href="./">3. WechatConf 详解</a>
</li>

                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">官方接口 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../../official/intro/">0. 前置介绍</a>
</li>

                    
                        
<li >
    <a href="../../official/access/">1. 接入指南</a>
</li>

                    
                        
<li >
    <a href="../../official/message/">2. 消息管理</a>
</li>

                    
                        
<li >
    <a href="../../official/menu/">3. 自定义菜单</a>
</li>

                    
                        
<li >
    <a href="../../official/website/">4. 微信网页开发</a>
</li>

                    
                        
<li >
    <a href="../../official/material/">5. 素材管理</a>
</li>

                    
                        
<li >
    <a href="../../official/user/">6. 用户管理</a>
</li>

                    
                        
<li >
    <a href="../../official/account/">7. 账号管理</a>
</li>

                    
                        
<li >
    <a href="../../official/datacube/">8. 数据统计</a>
</li>

                    
                        
<li >
    <a href="../../official/store/">9. 微信小店 </a>
</li>

                    
                        
<li >
    <a href="../../official/service/">10. 微信多客服功能</a>
</li>

                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">API 文档 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../../api/wechatconf/">1. WechatConf</a>
</li>

                    
                        
<li >
    <a href="../../api/wechatmessage/">2. WechatMessage</a>
</li>

                    
                        
<li >
    <a href="../../api/exception/">3. 异常类</a>
</li>

                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../../faq/">FAQ</a>
                </li>
            
            
            
                <li >
                    <a href="../../about/project/">关于项目</a>
                </li>
            
            
            
                <li >
                    <a href="../../about/author/">关于作者</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                <li >
                    <a rel="next" href="../official/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../../official/intro/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/wechat-python-sdk">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#-wechatconf">快速上手 - WechatConf 详解</a></li>
        
            <li><a href="#_1">基本信息传入</a></li>
        
            <li><a href="#access_token">access_token 维护</a></li>
        
            <li><a href="#jsapi_ticket">jsapi_ticket 维护</a></li>
        
            <li><a href="#_6">下一步</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="-wechatconf">快速上手 - WechatConf 详解<a class="headerlink" href="#-wechatconf" title="Permanent link">&para;</a></h1>
<p>WechatConf 是 <strong>微信配置类</strong>，你需要将在公众平台开发者选项中的 Token/AppID/AppSecret/EncodingAESKey 等信息传入其中，之后该类将会自行维护相关配置信息（access_token/jsapi_ticket）的有效性，支持分布式。</p>
<blockquote>
<p>Tips: v0.6.0 以前版本的用户请尽快迁移到 WechatConf 方式，原初始化方式将不会继续维护（但会一直保持兼容），也不会提供 EncodingAESKey 加密。</p>
</blockquote>
<h2 id="_1">基本信息传入<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>WechatConf 接受的基本信息包括：</p>
<ul>
<li>Token</li>
<li>App ID</li>
<li>App Secret</li>
<li>Encrypt Mode （消息加解密模式，可选项有 <code>normal</code>（明文模式）、<code>compatible</code>（兼容模式）、<code>safe</code>（安全模式）</li>
<li>EncodingAESKey （当 Encrypt Mode 为 <code>normal</code> 时无需传入此项）</li>
</ul>
<p>使用方式也很简单，示例：</p>
<pre><code class="python">from wechat_sdk import WechatConf
conf = WechatConf(
    token='your_token', 
    appid='your_appid', 
    appsecret='your_appsecret', 
    encrypt_mode='safe',  # 可选项：normal/compatible/safe，分别对应于 明文/兼容/安全 模式
    encoding_aes_key='your_encoding_aes_key'  # 如果传入此值则必须保证同时传入 token, appid
)
</code></pre>

<p>根据你自己需要传入对应参数即可，所有项均为可选项。</p>
<h2 id="access_token">access_token 维护<a class="headerlink" href="#access_token" title="Permanent link">&para;</a></h2>
<p>如果你在使用 WechatConf 的时候只传入基本信息，则会在每次实例化时请求一次 access_token。每天的 access_token 有着固定的次数限制，而且每次请求新的 access_token 会拖慢代码执行效率，所以，<strong>你需要根据你的代码运行环境及你的个人喜好选择下面任意一种方式缓存 access_token 的值。</strong></p>
<h3 id="1-">方式 1 - 单机环境<a class="headerlink" href="#1-" title="Permanent link">&para;</a></h3>
<p>单机环境下，可以将 access_token 及过期时间存放在任意位置（磁盘文件/数据库/缓存等）。你需要做的只是在每次 WechatConf 实例化的时候将你存储的 access_token 和 access_token_expires_at 作为参数传入即可，示例如下：</p>
<pre><code class="python">access_token = get_access_token_from_somewhere()
access_token_expires_at = get_access_token_expires_at_from_somewhere()

conf = WechatConf(
    ... ,  # 基本信息传入，此处忽略
    access_token=access_token,
    access_token_expires_at=access_token_expires_at,
)
</code></pre>

<p>当第一次实例化没有有效的 access_token 时，这两个参数全部传入 <code>None</code> 即可。</p>
<p>实例化完成后（首次实例化两个参数均使用 <code>None</code>），你需要在该实例有效期内的任意时刻调用 <a href="../../api/wechatconf/#get_access_token"><code>.get_access_token()</code></a> 方法获得自动维护过的新的 access_token 和 access_token_expires_at 值，然后将他们用你自己的方式（磁盘文件/数据库/缓存）进行保存，方便下次实例化的时候传入。</p>
<p><a href="../../api/wechatconf/#get_access_token"><code>.get_access_token()</code></a> 的返回示例如下：</p>
<pre><code class="python">{
    &quot;access_token&quot;:&quot;Uj6gDn1My01ElQvLXjudqdXlnTYosqWnxPT-1AX_jJEqeYhbqASZXPlnur7k6YV7Erjvd_JDXbQWeZYIMmu958WV4VWe7GKD65q_VLHecTp8nA5DwU_DOdmVBACU2wDkPGBbAHAEVQ&quot;,
    &quot;access_token_expires_at&quot;:1454476716
}
</code></pre>

<h3 id="2-">方式 2 - 单机环境<a class="headerlink" href="#2-" title="Permanent link">&para;</a></h3>
<p>第二种方式将 access_token 及 access_token_expires_at 的获取与设置的权利完全交付与你。你只需要写两个函数，分别去获取 access_token 和设置 access_token 即可。示例如下：</p>
<pre><code class="python">def get_access_token_function():
    &quot;&quot;&quot; 注意返回值为一个 Tuple，第一个元素为 access_token 的值，第二个元素为 access_token_expires_at 的值 &quot;&quot;&quot;
    return get_access_token_from_somewhere()  # 此处通过你自己的方式获取 access_token

def set_access_token_function(access_token, access_token_expires_at):
    set_access_token_to_somewhere(access_token, access_token_expires_at)  # 此处通过你自己的方式设置 access_token
</code></pre>

<p>接着你需要做的就是在 WechatConf 实例化的时候将这两个函数作为参数传入，如下：</p>
<pre><code class="python">from wechat_sdk import WechatConf
conf = WechatConf(
    ... ,  # 基本信息传入，此处忽略
    access_token_getfunc=get_access_token_function,
    access_token_setfunc=set_access_token_function,
)
</code></pre>

<p>经过以上步骤，WechatConf 实例内部在维护 access_token 有效性时均会调用你自己的函数去操作。</p>
<h3 id="3-">方式 3 - 分布式环境<a class="headerlink" href="#3-" title="Permanent link">&para;</a></h3>
<p>如果你需要在分布式环境下使用 wechat-python-sdk，那么服务器的类型分两种，一种是中控服务器，另一种是业务逻辑服务器：</p>
<ul>
<li>中控服务器用于 access_token 的获取和刷新，为业务逻辑服务器提供获取接口以及强制刷新接口。仅需一台中控服务器。</li>
<li>业务逻辑服务器的 access_token 均是调用中控服务器的接口得来，禁止业务逻辑服务器自行刷新 access_token。</li>
</ul>
<h4 id="_2">中控服务器<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<p>中控服务器的设置参考 <a href="#2-">方式 2 - 单机环境</a> 设置即可，推荐将 access_token 及 access_token_expires_at 放置于缓存服务器中。对外提供的接口需自行编写。</p>
<h4 id="_3">业务逻辑服务器<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<p>业务逻辑服务器的代码稍有些不同，因为不能直接通过腾讯官方 URL 来刷新 access_token，所以需要将刷新的操作转接到中控服务器上。WechatConf 提供了 <code>access_token_refreshfunc</code> 参数，你仍然只需要写两个函数，分别取获取 access_token 和刷新 access_token。示例如下：</p>
<pre><code class="python">def get_access_token_function():
    &quot;&quot;&quot; 注意返回值为一个 Tuple，第一个元素为 access_token 的值，第二个元素为 access_token_expires_at 的值 &quot;&quot;&quot;
    return get_access_token_from_master()  # 此处通过你自己的方式获取 access_token

def refresh_access_token_function():
    &quot;&quot;&quot; 注意返回值为一个 Tuple，第一个元素为 access_token 的值，第二个元素为 access_token_expires_at 的值 &quot;&quot;&quot;
    return refresh_access_token_from_master()  # 此处调用你自己的中控服务器刷新 access_token 接口
</code></pre>

<p>接下来需要在 WechatConf 实例化的时候将这两个函数作为参数传入，如下：</p>
<pre><code class="python">from wechat_sdk import WechatConf
conf = WechatConf(
    ... ,  # 基本信息传入，此处忽略
    access_token_getfunc=get_access_token_function,
    access_token_refreshfunc=refresh_access_token_function,
)
</code></pre>

<p>经过以上步骤，业务逻辑服务器的 WechatConf 实例内部在维护 access_token 有效性时均会调用你自己的函数去获取和刷新。</p>
<h2 id="jsapi_ticket">jsapi_ticket 维护<a class="headerlink" href="#jsapi_ticket" title="Permanent link">&para;</a></h2>
<p><strong>如果你的代码中并未涉及 JSSDK 的相关内容，那么你可以直接跳过本节。</strong></p>
<p>如果你在使用 WechatConf 的时候只传入基本信息，则会在每次实例化时请求一次 jsapi_ticket。每天的 jsapi_ticket 有着固定的次数限制，而且每次请求新的 jsapi_ticket 会拖慢代码执行效率，所以，<strong>你需要根据你的代码运行环境及你的个人喜好选择下面任意一种方式缓存 jsapi_ticket 的值。</strong></p>
<h3 id="1-_1">方式 1 - 单机环境<a class="headerlink" href="#1-_1" title="Permanent link">&para;</a></h3>
<p>单机环境下，可以将 jsapi_ticket 及过期时间存放在任意位置（磁盘文件/数据库/缓存等）。你需要做的只是在每次 WechatConf 实例化的时候将你存储的 jsapi_ticket 和 jsapi_ticket_expires_at 作为参数传入即可，示例如下：</p>
<pre><code class="python">jsapi_ticket = get_jsapi_ticket_from_somewhere()
jsapi_ticket_expires_at = get_jsapi_ticket_expires_at_from_somewhere()

conf = WechatConf(
    ... ,  # 基本信息传入，此处忽略
    jsapi_ticket=jsapi_ticket,
    jsapi_ticket_expires_at=jsapi_ticket_expires_at,
)
</code></pre>

<p>当第一次实例化没有有效的 jsapi_ticket 时，这两个参数全部传入 <code>None</code> 即可。</p>
<p>实例化完成后（首次实例化两个参数均使用 <code>None</code>），你需要在该实例有效期内的任意时刻调用 <a href="../../api/wechatconf/#get_jsapi_ticket"><code>.get_jsapi_ticket()</code></a> 方法获得自动维护过的新的 jsapi_ticket 和 jsapi_ticket_expires_at 值，然后将他们用你自己的方式（磁盘文件/数据库/缓存）进行保存，方便下次实例化的时候传入。</p>
<p><a href="../../api/wechatconf/#get_jsapi_ticket"><code>.get_jsapi_ticket()</code></a> 的返回示例如下：</p>
<pre><code class="python">{
    &quot;jsapi_ticket&quot;:&quot;bxLdikRXVbTPdHSM05e5u8EoHz_JA7Re-noqE0ZAnxk3XzAntyhT4_k272aJ4LprCM68rVXv6DDydT7JW1Mwsw&quot;,
    &quot;jsapi_ticket_expires_at&quot;: 1454476720
}
</code></pre>

<h3 id="2-_1">方式 2 - 单机环境<a class="headerlink" href="#2-_1" title="Permanent link">&para;</a></h3>
<p>第二种方式将 jsapi_ticket 及 jsapi_ticket_expires_at 的获取与设置的权利完全交付与你。你只需要写两个函数，分别去获取 jsapi_ticket 和设置 jsapi_ticket 即可。示例如下：</p>
<pre><code class="python">def get_jsapi_ticket_function():
    &quot;&quot;&quot; 注意返回值为一个 Tuple，第一个元素为 jsapi_ticket 的值，第二个元素为 jsapi_ticket_expires_at 的值 &quot;&quot;&quot;
    return get_jsapi_ticket_from_somewhere()  # 此处通过你自己的方式获取 jsapi_ticket

def set_jsapi_ticket_function(jsapi_ticket, jsapi_ticket_expires_at):
    set_jsapi_ticket_to_somewhere(jsapi_ticket, jsapi_ticket_expires_at)  # 此处通过你自己的方式设置 jsapi_ticket
</code></pre>

<p>接着你需要做的就是在 WechatConf 实例化的时候将这两个函数作为参数传入，如下：</p>
<pre><code class="python">from wechat_sdk import WechatConf
conf = WechatConf(
    ... ,  # 基本信息传入，此处忽略
    jsapi_ticket_getfunc=get_jsapi_ticket_function,
    jsapi_ticket_setfunc=set_jsapi_ticket_function,
)
</code></pre>

<p>经过以上步骤，WechatConf 实例内部在维护 jsapi_ticket 有效性时均会调用你自己的函数去操作。</p>
<h3 id="3-_1">方式 3 - 分布式环境<a class="headerlink" href="#3-_1" title="Permanent link">&para;</a></h3>
<p>如果你需要在分布式环境下使用 wechat-python-sdk，那么服务器的类型分两种，一种是中控服务器，另一种是业务逻辑服务器：</p>
<ul>
<li>中控服务器用于 jsapi_ticket 的获取和刷新，为业务逻辑服务器提供获取接口以及强制刷新接口。仅需一台中控服务器。</li>
<li>业务逻辑服务器的 jsapi_ticket 均是调用中控服务器的接口得来，禁止业务逻辑服务器自行刷新 jsapi_ticket。</li>
</ul>
<h4 id="_4">中控服务器<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<p>中控服务器的设置参考 <a href="#2-_1">方式 2 - 单机环境</a> 设置即可，推荐将 jsapi_ticket 及 jsapi_ticket_expires_at 放置于缓存服务器中。对外提供的接口需自行编写。</p>
<h4 id="_5">业务逻辑服务器<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>业务逻辑服务器的代码稍有些不同，因为不能直接通过腾讯官方 URL 来刷新 jsapi_ticket，所以需要将刷新的操作转接到中控服务器上。WechatConf 提供了 <code>jsapi_ticket_refreshfunc</code> 参数，你仍然只需要写两个函数，分别取获取 jsapi_ticket 和刷新 jsapi_ticket。示例如下：</p>
<pre><code class="python">def get_jsapi_ticket_function():
    &quot;&quot;&quot; 注意返回值为一个 Tuple，第一个元素为 jsapi_ticket 的值，第二个元素为 jsapi_ticket_expires_at 的值 &quot;&quot;&quot;
    return get_jsapi_ticket_from_master()  # 此处通过你自己的方式获取 jsapi_ticket

def refresh_jsapi_ticket_function():
    &quot;&quot;&quot; 注意返回值为一个 Tuple，第一个元素为 jsapi_ticket 的值，第二个元素为 jsapi_ticket_expires_at 的值 &quot;&quot;&quot;
    return refresh_jsapi_ticket_from_master()  # 此处调用你自己的中控服务器刷新 jsapi_ticket 接口
</code></pre>

<p>接下来需要在 WechatConf 实例化的时候将这两个函数作为参数传入，如下：</p>
<pre><code class="python">from wechat_sdk import WechatConf
conf = WechatConf(
    ... ,  # 基本信息传入，此处忽略
    jsapi_ticket_getfunc=get_jsapi_ticket_function,
    jsapi_ticket_refreshfunc=refresh_jsapi_ticket_function,
)
</code></pre>

<p>经过以上步骤，业务逻辑服务器的 WechatConf 实例内部在维护 jsapi_ticket 有效性时均会调用你自己的函数去获取和刷新。</p>
<h2 id="_6">下一步<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p>现在你已经了解了如何将基本信息传入 WechatConf 并自行维护 access_token 及 jsapi_ticket 的有效性。</p>
<p>接下来，你可以：</p>
<ul>
<li>继续阅读 <a href="../../api/wechatconf/">WechatConf API</a> 加深对 WechatConf 的印象</li>
<li>直接点击导航栏上方的的 <strong>官方接口</strong>，选择自己需要的章节进行阅读</li>
</ul></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
                <center>Copyright 2014-2016 Ace Kwok</center>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>