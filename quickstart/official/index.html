<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://wechat-python-sdk.com/quickstart/official/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>2. 官方接口 - wechat-python-sdk</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">wechat-python-sdk</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">首页</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">快速上手 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../intro/">1. SDK 快速介绍</a>
</li>

                    
                        
<li class="active">
    <a href="./">2. 官方接口</a>
</li>

                    
                        
<li >
    <a href="../wechatconf/">3. WechatConf 详解</a>
</li>

                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">官方接口 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../../official/intro/">0. 前置介绍</a>
</li>

                    
                        
<li >
    <a href="../../official/access/">1. 接入指南</a>
</li>

                    
                        
<li >
    <a href="../../official/message/">2. 消息管理</a>
</li>

                    
                        
<li >
    <a href="../../official/menu/">3. 自定义菜单</a>
</li>

                    
                        
<li >
    <a href="../../official/website/">4. 微信网页开发</a>
</li>

                    
                        
<li >
    <a href="../../official/material/">5. 素材管理</a>
</li>

                    
                        
<li >
    <a href="../../official/user/">6. 用户管理</a>
</li>

                    
                        
<li >
    <a href="../../official/account/">7. 账号管理</a>
</li>

                    
                        
<li >
    <a href="../../official/datacube/">8. 数据统计</a>
</li>

                    
                        
<li >
    <a href="../../official/store/">9. 微信小店 </a>
</li>

                    
                        
<li >
    <a href="../../official/service/">10. 微信多客服功能</a>
</li>

                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">API 文档 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../../api/wechatconf/">1. WechatConf</a>
</li>

                    
                        
<li >
    <a href="../../api/wechatmessage/">2. WechatMessage</a>
</li>

                    
                        
<li >
    <a href="../../api/exception/">3. 异常类</a>
</li>

                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../../faq/">FAQ</a>
                </li>
            
            
            
                <li >
                    <a href="../../about/project/">关于项目</a>
                </li>
            
            
            
                <li >
                    <a href="../../about/author/">关于作者</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                <li >
                    <a rel="next" href="../intro/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../wechatconf/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/wechat-python-sdk">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#-">快速上手 - 官方接口</a></li>
        
            <li><a href="#wechatconf">实例化 WechatConf 微信配置类</a></li>
        
            <li><a href="#wechatbasic">实例化 WechatBasic 官方接口类</a></li>
        
            <li><a href="#_1">验证服务器请求有效性</a></li>
        
            <li><a href="#xml">解析接收到的 XML 消息</a></li>
        
            <li><a href="#_2">获取解析后的信息</a></li>
        
            <li><a href="#_5">回复消息</a></li>
        
            <li><a href="#_12">总结</a></li>
        
            <li><a href="#_13">下一步</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="-">快速上手 - 官方接口<a class="headerlink" href="#-" title="Permanent link">&para;</a></h1>
<p>本页内容提供了一些可以快速上手的短小示例代码，并假设你已经安装了 wechat-python-sdk 。如果还没有，请返回 <a href="../../#_2">安装</a> 一节遵循提示进行安装。</p>
<p>在开始之前，请准备好你的：</p>
<ul>
<li>Token（可选）</li>
<li>App ID / App Secret (可选)</li>
<li>EncodingAESKey (可选)</li>
</ul>
<p>你没有看错，他们都是可选项，但如果你什么都不提供，那执行方法的时候就会抛出一堆无法执行操作的异常了 :)</p>
<h2 id="wechatconf">实例化 WechatConf 微信配置类<a class="headerlink" href="#wechatconf" title="Permanent link">&para;</a></h2>
<p>这里给出一个简单的 <code>WechatConf</code> 实例化代码：</p>
<pre><code class="python">from wechat_sdk import WechatConf
conf = WechatConf(
    token='your_token', 
    appid='your_appid', 
    appsecret='your_appsecret', 
    encrypt_mode='safe',  # 可选项：normal/compatible/safe，分别对应于 明文/兼容/安全 模式
    encoding_aes_key='your_encoding_aes_key'  # 如果传入此值则必须保证同时传入 token, appid
)
</code></pre>

<p>上面所有的参数都是可选的，请按需传入即可。</p>
<p><strong>下面的所有代码会始终假设变量 <code>conf</code> 已经通过上述方式实例化完毕，将会直接使用而不再进行详细说明。</strong></p>
<h2 id="wechatbasic">实例化 WechatBasic 官方接口类<a class="headerlink" href="#wechatbasic" title="Permanent link">&para;</a></h2>
<p><code>WechatBasic</code> 的实例化只需要将已经实例化好的 <code>conf</code> 传入即可，如下：</p>
<pre><code class="python">from wechat_sdk import WechatBasic
wechat = WechatBasic(conf=conf)
</code></pre>

<p>接下来，你就可以使用 <code>wechat</code> 变量来完成你所需要的所有功能。</p>
<p><strong>下面的所有代码会始终假设变量 <code>wechat</code> 已经通过上述方式实例化完毕，将会直接使用而不再进行详细说明。</strong></p>
<h2 id="_1">验证服务器请求有效性<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>首先假设你已经自行从微信服务器发送的 Request 中提取出了 <code>signature</code>, <code>timestamp</code>, <code>nonce</code> 参数，下面将直接使用这三个变量：</p>
<pre><code class="python">if wechat.check_signature(signature, timestamp, nonce):
    print 'Accept'
else:
    print 'Wrong'
</code></pre>

<p>Tips: 该方法在执行前会检查 <code>conf</code> 中是否传入了 <code>token</code> 参数，如果没有传入则抛出 <code>NeedParamError</code> 异常（该异常继承自 <code>WechatSDKException</code>）。</p>
<h2 id="xml">解析接收到的 XML 消息<a class="headerlink" href="#xml" title="Permanent link">&para;</a></h2>
<p>首先假设你已经自行从微信服务器发送的 Request 中提取出了 <code>body_text</code>（也就是 Request 中的 body），下面将直接使用该变量：</p>
<pre><code class="python">from wechat_sdk.exceptions import ParseError
try:
    wechat.parse_data(body_text)
except ParseError:
    print 'Invalid Body Text'
</code></pre>

<p>这里的 <code>ParseError</code> 异常继承自 <code>WechatSDKException</code>，当解析数据出错时被抛出。</p>
<p>如果解析成功，将不会有任何返回信息，也不会有异常抛出。</p>
<h2 id="_2">获取解析后的信息<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>当解析成功后，你可以直接获取解析后的具体信息：</p>
<h3 id="_3">公共信息获取<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<pre><code class="python">id = wechat.message.id          # 对应于 XML 中的 MsgId
target = wechat.message.target  # 对应于 XML 中的 ToUserName
source = wechat.message.source  # 对应于 XML 中的 FromUserName
time = wechat.message.time      # 对应于 XML 中的 CreateTime
type = wechat.message.type      # 对应于 XML 中的 MsgType
raw = wechat.message.raw        # 原始 XML 文本，方便进行其他分析
</code></pre>

<h3 id="_4">私有信息获取<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>当 <code>isinstance(wechat.message, TextMessage)</code> 时，有：</p>
<pre><code class="python">content = wechat.message.content                   # 对应于 XML 中的 Content
</code></pre>

<p>当 <code>isinstance(wechat.message, ImageMessage)</code> 时，有：</p>
<pre><code class="python">picurl = wechat.message.picurl                     # 对应于 XML 中的 PicUrl
media_id = wechat.message.media_id                 # 对应于 XML 中的 MediaId
</code></pre>

<p>当 <code>isinstance(wechat.message, VoiceMessage)</code> 时，有：</p>
<pre><code class="python">media_id = wechat.message.media_id                 # 对应于 XML 中的 MediaId
format = wechat.message.format                     # 对应于 XML 中的 Format
recognition = wechat.message.recognition           # 对应于 XML 中的 Recognition
</code></pre>

<p>当 <code>isintance(wechat.message, VideoMessage)</code> 或 <code>isinstance(wechat.message, ShortVideoMessage)</code> 时，有：</p>
<pre><code class="python">media_id = wechat.message.media_id                 # 对应于 XML 中的 MediaId
thumb_media_id = wechat.message.thumb_media_id     # 对应于 XML 中的 ThumbMediaId
</code></pre>

<p>当 <code>isinstance(wechat.message, LocationMessage)</code> 时，有：</p>
<pre><code class="python">location = wechat.message.location                 # Tuple(X, Y)，对应于 XML 中的 (Location_X, Location_Y)
scale = wechat.message.scale                       # 对应于 XML 中的 Scale
label = wechat.message.label                       # 对应于 XML 中的 Label
</code></pre>

<p>当 <code>isinstance(wechat.message, LinkMessage)</code> 时，有：</p>
<pre><code class="python">title = wechat.message.title                       # 对应于 XML 中的 Title
description = wechat.message.description           # 对应于 XML 中的 Description
url = wechat.message.url                           # 对应于 XML 中的 Url
</code></pre>

<p>当 <code>isinstance(wechat.message, EventMessage)</code> 时，有：</p>
<pre><code class="python">if wechat.message.type == 'subscribe':  # 关注事件(包括普通关注事件和扫描二维码造成的关注事件)
    key = wechat.message.key                        # 对应于 XML 中的 EventKey (普通关注事件时此值为 None)
    ticket = wechat.message.ticket                  # 对应于 XML 中的 Ticket (普通关注事件时此值为 None)
elif wechat.message.type == 'unsubscribe':  # 取消关注事件（无可用私有信息）
    pass
elif wechat.message.type == 'scan':  # 用户已关注时的二维码扫描事件
    key = wechat.message.key                        # 对应于 XML 中的 EventKey
    ticket = wechat.message.ticket                  # 对应于 XML 中的 Ticket
elif wechat.message.type == 'location':  # 上报地理位置事件
    latitude = wechat.message.latitude              # 对应于 XML 中的 Latitude
    longitude = wechat.message.longitude            # 对应于 XML 中的 Longitude
    precision = wechat.message.precision            # 对应于 XML 中的 Precision
elif wechat.message.type == 'click':  # 自定义菜单点击事件
    key = wechat.message.key                        # 对应于 XML 中的 EventKey
elif wechat.message.type == 'view':  # 自定义菜单跳转链接事件
    key = wechat.message.key                        # 对应于 XML 中的 EventKey
elif wechat.message.type == 'templatesendjobfinish':  # 模板消息事件
    status = wechat.message.status                  # 对应于 XML 中的 Status
elif wechat.message.type in ['scancode_push', 'scancode_waitmsg', 'pic_sysphoto', 
                             'pic_photo_or_album', 'pic_weixin', 'location_select']:  # 其他事件
    key = wechat.message.key                        # 对应于 XML 中的 EventKey
</code></pre>

<h2 id="_5">回复消息<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p><strong>回复消息要求必须已经成功调用过 <code>.parse_data()</code> 方法。</strong></p>
<p>另外以下 <code>response_</code> 系列函数仅返回处理好的 XML 字符串，你还需要将它通过你自己的框架封装为 HTTP Response 返回微信服务器。</p>
<h3 id="_6">回复文本消息<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<pre><code class="python">xml = wechat.response_text(content='文本回复')
</code></pre>

<p>如果需要转义文本，可以传入参数 <code>escape=True</code>：</p>
<pre><code class="python">xml = wechat.response_text(content='文本回复', escape=True)
</code></pre>

<h3 id="_7">回复图片消息<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<pre><code class="python">xml = wechat.response_image(media_id='media_id')
</code></pre>

<h3 id="_8">回复语音消息<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<pre><code class="python">xml = wechat.response_voice(media_id='media_id')
</code></pre>

<h3 id="_9">回复视频消息<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<pre><code class="python">xml = wechat.response_video(media_id='media_id', title='video_title', description='video_description')
</code></pre>

<p>以上参数中 <code>title</code> 和 <code>description</code> 均为可选项。</p>
<h3 id="_10">回复音乐消息<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<pre><code class="python">xml = wechat.response_music(
    music_url='your_music_url',
    title='music_title',
    description='music_description',
    hq_music_url='your_hq_music_url',
    thumb_media_id='your_thumb_media_id',
)
</code></pre>

<p>以上参数中 <code>title</code>、<code>description</code>、<code>hq_music_url</code>、<code>thumb_media_id</code> 均为可选项。</p>
<h3 id="_11">回复图文消息<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<pre><code class="python">xml = wechat.response_news([
    {
        'title': u'第一条新闻标题',
        'description': u'第一条新闻描述，这条新闻没有预览图',
        'url': u'http://www.google.com.hk/',
    }, {
        'title': u'第二条新闻标题, 这条新闻无描述',
        'picurl': u'http://doraemonext.oss-cn-hangzhou.aliyuncs.com/test/wechat-test.jpg',
        'url': u'http://www.github.com/',
    }, {
        'title': u'第三条新闻标题',
        'description': u'第三条新闻描述',
        'picurl': u'http://doraemonext.oss-cn-hangzhou.aliyuncs.com/test/wechat-test.jpg',
        'url': u'http://www.v2ex.com/',
    }
])
</code></pre>

<h2 id="_12">总结<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h2>
<p>通过上面的文档你应该已经掌握了如何使用 wechat-python-sdk 进行基本的：</p>
<ul>
<li><strong>验证服务器请求有效性</strong></li>
<li><strong>解析接收到的 XML 消息</strong></li>
<li><strong>获取解析后的信息</strong></li>
<li><strong>回复消息</strong> </li>
</ul>
<p>等操作，通过它们，你可以快速搭建一个最简单的服务来应对微信服务器的请求。</p>
<h2 id="_13">下一步<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h2>
<p>接下来请阅读 <a href="../../quickstart/wechatconf"><strong>快速上手 - WechatConf 详解</strong></a> 来了解如何使用 WechatConf 维护配置信息，可以说，它将是官方接口使用过程中最重要的一环。</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
                <center>Copyright 2014-2016 Ace Kwok</center>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>